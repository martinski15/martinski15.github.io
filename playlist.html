<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Our Playlist â™¥ï¸ â€“ Martin &amp; Isa</title>
  <link rel="stylesheet" href="css/style.css" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* match your siteâ€™s look */
    body { background:#fbfbf3; font-family:Georgia, serif; margin:0 }
    main { max-width:800px; margin:2rem auto; padding:0 1rem; }
    h1 { color:#a8132b; font-size:2.75rem; text-align:center; }
    .controls { display:flex; gap:0.5rem; margin-bottom:2rem; }
    .controls input, .controls button {
      flex:1; padding:.75rem; border:2px solid #a8132b; border-radius:.75rem;
      font-size:1rem;
    }
    .controls button { background:#a8132b; color:white; cursor:pointer; }
    .playlist { display:grid; gap:1.5rem; }
    .track { position:relative; background:white; padding:1rem; border-radius:.75rem;
             box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    .track iframe { width:100%; height:80px; border:none; border-radius:.5rem; }
    .track .remove {
      position:absolute; top:.5rem; right:.5rem; background:transparent;
      border:none; font-size:1.25rem; color:#888; cursor:pointer;
    }
    .track .remove:hover { color:#a00 }
  </style>
</head>
<body>

  <nav>
    <div class="logo">
      <a href="index.html">Martin &amp; Isa â™¥ï¸</a>
    </div>
    <ul>
      <li><a href="our-story.html">Our Story</a></li>
      <li><a href="playlist.html" class="active">Our Playlist</a></li>
      <li><a href="500-things.html">500 Things</a></li>
      <li><a href="bucket-list.html">Bucket List</a></li>
      <li>
        <a href="https://martinski15.github.io/2048-personalized/"
           target="_blank" rel="noopener">2048</a>
      </li>
      <li><a href="surprise.html" class="surprise">Surprise ğŸ¤</a></li>
    </ul>
  </nav>

  <main>
    <h1>Our Playlist â™¥ï¸</h1>
    <div class="controls">
      <input id="track-url" placeholder="Paste Spotify URLâ€¦" />
      <button id="add-btn">Add Track</button>
    </div>
    <div id="playlist" class="playlist"></div>
  </main>

  <script>
    // â”€â”€â”€ 2) Initialize Supabase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const SUPABASE_URL = 'https://clwmpfzqaizzqvtgtuxb.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsd21wZnpxYWl6enRndXhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0NDQ4MDYsImV4cCI6MjA2ODAyMDgwNn0.kgGLm4j6TUqbEPNFy3HoVNXtRmHwk6sBCy05hTKhBxU';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // DOM refs
    const inp   = document.getElementById('track-url');
    const btn   = document.getElementById('add-btn');
    const cont  = document.getElementById('playlist');

    // â”€â”€â”€ 3) Fetch & render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function fetchAndRender() {
      const { data, error } = await supabase
        .from('tracks')
        .select('id, src')
        .order('inserted_at', { ascending: true });
      if (error) return console.error(error);

      cont.innerHTML = '';
      data.forEach(({ id, src }) => {
        const div = document.createElement('div');
        div.className = 'track';

        // remove button
        const rm = document.createElement('button');
        rm.className = 'remove';
        rm.textContent = 'âœ–';
        rm.onclick = () => removeTrack(id);

        // embedded player
        const iframe = document.createElement('iframe');
        iframe.src   = src;
        iframe.allow = 'encrypted-media; autoplay';

        div.append(rm, iframe);
        cont.append(div);
      });
    }

    // â”€â”€â”€ 4) Add new track â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    btn.addEventListener('click', async () => {
      const url = inp.value.trim();
      let src = null;
      // detect Spotify
      let m = url.match(/\/track\/([A-Za-z0-9]+)/);
      if (m) src = `https://open.spotify.com/embed/track/${m[1]}`;
      // detect YT
      else if ((m = url.match(/(?:youtu\.be\/|v=)([A-Za-z0-9_-]+)/))) {
        src = `https://www.youtube.com/embed/${m[1]}`;
      }
      if (!src) return alert('Please paste a valid Spotify track URL.');
      await supabase.from('tracks').insert({ src });
      inp.value = '';
      fetchAndRender();
    });

    // â”€â”€â”€ 5) Remove track â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function removeTrack(id) {
      await supabase.from('tracks').delete().eq('id', id);
      fetchAndRender();
    }

    // â”€â”€â”€ 6) Live updates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    supabase
      .channel('public:tracks')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'tracks' },
        () => fetchAndRender()
      )
      .subscribe();

    // â”€â”€â”€ 7) Init on page load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.addEventListener('DOMContentLoaded', fetchAndRender);
  </script>
</body>
</html>
